<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

    <title>Book store</title>
</head>

<body>
    <div class="container mb-4" id="update-form">
        <h1 class="text-center" v-if="path === 'update'">Cập nhật sách</h1>
        <h1 class="text-center" v-if="path === 'add'">Thêm mới sách</h1>

        <div class="row justify-content-around">
            <!-- start button and form -->
            <div class="w-50" style="margin: 0 auto;" id="form">
                <form>
                    <div class="mb-3">
                        <label for="email" class="form-label">Tên sách</label>
                        <input type="text" class="form-control inputForm" v-model="book.name">
                    </div>
                    <div class="mb-3">
                        <label for="author" class="form-label">Tên tác giả</label>
                        <input type="text" class="form-control inputForm" v-model="book.author">
                    </div>
                    <div class="mb-3">
                        <label for="desc" class="form-label">Mô tả</label>
                        <input type="text" class="form-control inputForm" v-model="book.description">
                    </div>
                    <div class="mb-3">
                        <label for="price" class="form-label">Giá</label>
                        <input type="number" min="0" class="form-control inputForm" v-model="book.price">
                    </div>
                    <button v-if="path === 'update'" type="submit" class="btn btn-primary" id="submit_btn" v-on:click.stop.prevent="handleUpdate">Cập nhật</button>
                    <button v-if="path === 'add'" type="submit" class="btn btn-primary" id="submit_btn" v-on:click.stop.prevent="handleCreate">Thêm mới</button>
                </form>
            </div>
            <!-- end button and form -->
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script type="module">

        import { callApi } from '/static/js/fetchApi.js';
        import URL from '/static/js/url.js';

        var updateForm = new Vue({
            el: '#update-form',
            data: {
                book: {
                    name: "",
                    author: "",
                    description: "",
                    price: 0
                },
                book_id: null,
                path: ""
            },
            methods: {
                async updateData() {
                    if (!this.book_id) {
                        this.getBookId();
                    }
                    if (this.book_id) {
                        try {
                            const res = await callApi('PUT', URL.BOOK_URL + "/" + this.book_id, this.book);
                            alert("Cập nhật thành công");
                            window.location.pathname = "/";
                        } catch (err) {
                            alert(err);
                        }
                    }else{
                        alert("The url is not vallid");
                    }
                },
                async createData() {
                    if (this.path === "add") {
                        try {
                            const res = await callApi('POST', URL.BOOK_URL, this.book);
                            alert("Tạo mới thành công");
                            window.location.pathname = "/";
                        } catch (err) {
                            alert(err);
                        }
                    }else{
                        alert("The url is not vallid");
                    }
                },
                async getById() {
                    if (!this.book_id) {
                        this.getBookId();
                    }
                    if (this.book_id) {
                        try {
                            const res = await callApi('GET', URL.BOOK_URL + "/" + this.book_id);
                            this.book = { ...res };
                        } catch (err) {
                            alert(err);
                        }
                    }else{
                        if(this.path === "update")
                        alert("The url is not vallid");
                    }
                },
                getBookId() {
                    let arr = window.location.pathname.split("/");
                    let id = arr[3];
                    this.path = arr[2];
                    if (id) {
                        id = parseInt(id);
                        if (Number.isInteger(id)) {
                            this.book_id = id;
                        }
                    }
                },
                handleUpdate(){
                    this.updateData();
                },
                handleCreate(){
                    this.createData();
                }
            },
            created: function () {
                this.getById();
            }
        })
    </script>
</body>

</html>